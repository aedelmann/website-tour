{{ define "main" }}
<!-- Hero -->
<section class="hero-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h1>
                    <i class="fas fa-route me-2"></i>
                    {{ .Site.Title }}
                </h1>
                <p>{{ .Site.Params.description }}</p>
                <small><i class="fas fa-car me-1"></i> Traveling Europe in our {{ .Site.Params.tesla_model }}</small>
            </div>
        </div>
    </div>
</section>

<!-- Intro – Meet us -->
<section class="intro-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-5 mb-4 mb-lg-0 text-center">
                <img src="{{ "/images/intro/alex+cristyne.jpeg" | relURL }}" alt="{{ .Site.Params.author }}" class="img-fluid rounded intro-photo">
            </div>
            <div class="col-lg-7">
                <h2 class="mb-3">Meet the wanderers</h2>
                <p class="lead text-muted mb-3">
                    We're {{ .Site.Params.author }}, and this is our journey. We're exploring Europe and beyond in our {{ .Site.Params.tesla_model }}, sharing the places we discover and the stories along the way.
                </p>
                <p class="text-muted mb-0">
                    Follow along as we document our adventures, from city stops to mountain roads—one silent mile at a time.
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Interactive Map Section -->
<section class="py-4">
    <div class="container">
        <div class="row mb-3">
            <div class="col-12 text-center">
                <h2 class="mb-2">
                    <i class="fas fa-map-marked-alt me-2"></i>Our Journey Map
                </h2>
                <p class="text-muted mb-0">Click on any pin to read about our adventures at that location</p>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div id="homeMap" style="height: 560px; min-height: 400px;"></div>
            </div>
        </div>
    </div>
</section>

<!-- Latest Posts Section -->
<section class="py-5">
    <div class="container">
        <h2 class="text-center mb-5">
            <i class="fas fa-newspaper me-2"></i>Latest Adventures
        </h2>
        <div class="row">
            {{ range first 3 (where .Site.RegularPages "Type" "posts") }}
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    {{ if .Params.featured_image }}
                    <img src="{{ .Params.featured_image | relURL }}" class="card-img-top" alt="{{ .Title }}" style="height: 200px; object-fit: cover;">
                    {{ end }}
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ .Title }}</h5>
                        <p class="card-text text-muted">{{ .Summary | truncate 120 }}</p>
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    {{ .Date.Format "Jan 2, 2006" }}
                                </small>
                                {{ if .Params.location }}
                                <small class="text-muted">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    {{ .Params.location }}
                                </small>
                                {{ end }}
                            </div>
                            <a href="{{ .RelPermalink }}" class="btn btn-primary btn-sm mt-2">
                                Read More <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {{ end }}
        </div>
        <div class="text-center mt-4">
            <a href="{{ "/posts/" | relURL }}" class="btn btn-outline-primary">
                View All Posts <i class="fas fa-arrow-right ms-1"></i>
            </a>
        </div>
    </div>
</section>

{{ end }}

{{ define "scripts" }}
{{ $mapLocations := slice }}
{{ range where .Site.RegularPages "Type" "posts" }}
  {{ if .Params.latitude }}
  {{ $summary := .Summary | plainify | truncate 100 }}
  {{ $img := .Params.featured_image }}
  {{ if $img }}{{ $img = $img | relURL }}{{ end }}
  {{ $mapLocations = $mapLocations | append (dict "lat" .Params.latitude "lng" .Params.longitude "title" .Title "url" .RelPermalink "date" (.Date.Format "Jan 2, 2006") "location" .Params.location "summary" $summary "featured_image" $img "distance" (default 0 (.Param "tesla_stats.distance"))) }}
  {{ end }}
{{ end }}
<script type="application/json" id="homeMapLocations">{{ $mapLocations | jsonify }}</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var mapEl = document.getElementById('homeMap');
    if (!mapEl || typeof L === 'undefined') return;

    try {
        var homeMap = L.map('homeMap').setView([
            {{ .Site.Params.map_center_lat | default 50.0755 }},
            {{ .Site.Params.map_center_lng | default 14.4378 }}
        ], {{ .Site.Params.map_zoom | default 6 }});

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(homeMap);

        var teslaIcon = L.divIcon({
            html: '<i class="fas fa-car" style="color: #b45309; font-size: 24px;"></i>',
            iconSize: [30, 30],
            className: 'custom-div-icon'
        });

        var locationsEl = document.getElementById('homeMapLocations');
        var locations = [];
        if (locationsEl) {
            try {
                var raw = locationsEl.textContent.trim();
                locations = JSON.parse(raw);
                if (typeof locations === 'string') locations = JSON.parse(locations);
            } catch (err) { console.warn('Map locations parse error:', err); }
        }

        var baseUrl = window.location.origin;
        function escapeHtml(s) {
            if (!s) return '';
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }
        var bounds = [];
        locations.forEach(function(location) {
            bounds.push([location.lat, location.lng]);
            var marker = L.marker([location.lat, location.lng], { icon: teslaIcon }).addTo(homeMap);
            var imgSrc = location.featured_image
                ? (location.featured_image.indexOf('http') === 0 ? location.featured_image : baseUrl + (location.featured_image.indexOf('/') === 0 ? '' : '/') + location.featured_image)
                : '';
            var imgHtml = imgSrc ? '<img src="' + imgSrc.replace(/"/g, '&quot;') + '" alt="" class="img-fluid" style="max-width: 200px; border-radius: 8px; margin: 0.5rem 0;">' : '';
            var popupContent = '<div class="map-popup">' +
                '<h6>' + escapeHtml(location.title) + '</h6>' +
                '<p class="mb-2"><strong>' + escapeHtml(location.location) + '</strong></p>' +
                '<p class="text-muted small mb-2">' + escapeHtml(location.date) + '</p>' + imgHtml +
                '<p class="small mt-2">' + escapeHtml(location.summary) + '</p>' +
                '<a href="' + escapeHtml(location.url) + '" class="btn btn-primary btn-sm">Read Post <i class="fas fa-arrow-right ms-1"></i></a>' +
                '</div>';
            marker.bindPopup(popupContent);
        });

        if (bounds.length > 0) {
            homeMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 6 });
        }

        var totalDistance = locations.reduce(function(sum, loc) { return sum + loc.distance; }, 0);
        var countries = new Set(locations.map(function(l) { return l.location.split(',').pop().trim(); })).size;
        var postsEl = document.getElementById('home-posts-count');
        if (postsEl) postsEl.textContent = locations.length;
        var countriesEl = document.getElementById('home-countries-count');
        if (countriesEl) countriesEl.textContent = countries;
        var distanceEl = document.getElementById('home-distance');
        if (distanceEl) distanceEl.textContent = totalDistance.toLocaleString();
        var daysEl = document.getElementById('home-days');
        if (daysEl) daysEl.textContent = Math.ceil(locations.length * 2.5);
    } catch (e) {
        console.error('Home map init error:', e);
        mapEl.innerHTML = '<p class="text-center text-muted py-5">Map could not be loaded. Please refresh the page.</p>';
    }
});
</script>

<style>
.tesla-home-image {
    max-height: 300px;
    width: auto;
    object-fit: contain;
}
</style>
{{ end }}

